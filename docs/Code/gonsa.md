# ğŸµ éŸ³é¢‘å¯è§†åŒ–ä¸ThreeJSçš„å¼€å‘

Demo: [music.suningyao.com](https://music.suningyao.com/)

Repo: [github.com/fewwwww/music.suningyao.com](https://github.com/fewwwww/music.suningyao.com)

## å‰è¨€

Gonsa è¿™ä¸ªé¡¹ç›®æ˜¯æˆ‘åœ¨ NYU IDM çš„ WebGL è¯¾ç¨‹çš„æœŸæœ«ä½œä¸š, ä¸ºä¸€ä¸ªéŸ³é¢‘å¯è§†åŒ–ç½‘ç«™, å¯¹æˆ‘çš„å¤šé¦–ç²¾é€‰åŸåˆ›éŸ³ä¹è¿›è¡Œäº†å¯è§†åŒ–.

ç½‘ç«™é‡‡ç”¨äº† ThreeJS ä½œä¸º 3D å¼•æ“, TypeScript ä½œä¸ºè¯­è¨€, Vite ä½œä¸ºå·¥å…·é“¾, MVC ä½œä¸ºè®¾è®¡æ¨¡å¼, Web Audio API ä½œä¸ºéŸ³é¢‘å¤„ç†, SimplexNoise è¾…åŠ©å¯è§†åŒ–ç”Ÿæˆ.

## è®¾è®¡

è®¾è®¡ä¸Š, ç”±äºå¯¹è‡ªå·±çš„è®¾è®¡åŠŸåŠ›çš„ä¸è‡ªä¿¡, æˆ‘ä¸€å¼€å§‹å°±å†³å®šå‡å°‘ä¸å¿…è¦çš„è®¾è®¡, åªä¿ç•™æœ€å°‘çš„å…ƒç´ . åŒæ—¶æ²¡æœ‰åšé¢å¤–çš„éŸ³ä¹æ’­æ”¾å™¨ç­‰æ ·å¼.

![](/img/gonsa/1.png)

é¢œè‰²ä¸Š, æˆ‘é€‰æ‹©äº†é»‘ä¸ç™½ä¸¤ç§é¢œè‰², è®©è§†è§‰æ›´åŠ æ¸…æ™°. å¸ƒå±€ä¸Š, æ•´ä¸ªé¡¹ç›®ä»…æœ‰ä¸€ä¸ªæŒ‰é’®, ä»¥åŠä¸¤ä¸ªé¡µé¢ä¸­çš„ä¸åŒ 3D å›¾å½¢. äº¤äº’ä¸Š, æˆ‘ä¸ºå”¯ä¸€çš„æŒ‰é’®è®¾è®¡ä¸Šäº†ç‚¹å‡»æ•ˆæœä»¥åŠæ‚¬åœæ•ˆæœ.

![](/img/gonsa/2.png)

å›¾å½¢çš„æ„å»ºä¸Š, æˆ‘é‡‡ç”¨äº†éå¸¸å¤šçš„çº¿æ¡, è™½ç„¶éƒ½æ˜¯ 3D å›¾å½¢, ä½†æ²¡æœ‰ä»»ä½•å¤§çš„è‰²å—, è€Œæ˜¯ä»…å‰©ä¸€ä¸ªæ ¸å¿ƒçš„éª¨æ¶, ä¸ºç”»é¢æ·»åŠ äº†æ›´å¤šçš„ç•™ç™½.

![](/img/gonsa/3.png)

å›¾å½¢çš„åŠ¨æ•ˆä¸Š, æˆ‘è®©èµ·å§‹é¡µçš„å›¾å½¢éšæœºå˜åŒ–é•¿åº¦, ä¸»é¡µé¢çš„çƒå½¢éšç€éŸ³ä¹å˜åŒ–å¾‹åŠ¨.

![](/img/gonsa/4.png)

äº¤äº’ä¸Š, ç”¨æˆ·çš„é¼ æ ‡ä½ç½®ä¼šå¼•èµ·è§†è§’çš„å˜åŒ–.

éŸ³ä¹ä¸Š, æˆ‘å¹¶æ²¡æœ‰é€‰æ‹©ç”¨æˆ·ä¸Šä¼ è‡ªå·±çš„éŸ³ä¹, è€Œæ˜¯æŒ‡å®šäº†æˆ‘çš„éŸ³ä¹, è¿™æ˜¯ä¸ºäº†é¿å…è¿‡å¤šçš„ç”¨æˆ·æ“ä½œä»¥åŠé£æ ¼çš„ç»Ÿä¸€. éŸ³ä¹çš„é€‰å–æˆ‘åˆæ­¥é€‰æ‹©äº†ä¸€äº›è‡ªå·±å–œæ¬¢çš„åŸåˆ›çš„éŸ³ä¹, å¹¶ä¸”æŒ‘é€‰å‡ºäº†å‡ ä¸ªå±•ç¤ºæ•ˆæœæ˜æ˜¾çš„.

ä»£ç ä¸Š, æˆ‘å°½åŠ›ç®€åŒ–äº†ä»£ç è¡Œæ•°, æ–‡ä»¶æ•°ç­‰.

## ç»†èŠ‚

### 1. èµ·å§‹é¡µå›¾å½¢å½¢çŠ¶

è™½ç„¶æ˜¯ç”¨çš„ ThreeJS çš„ 3D æ¡†æ¶, ä½†æ˜¯èµ·å§‹é¡µçš„å›¾å½¢çœ‹ç€åƒæ˜¯çº¿æ¡, è¿™æ˜¯å› ä¸ºä¸ºäº†è®¾è®¡ä¸Šçš„ç¾è§‚, æˆ‘è®©è¿™å‡ ä¸ªé•¿æ–¹ä½“çš„å®½åº¦å’Œæ·±åº¦éƒ½å˜æˆ 0 äº†.

```js
// add one bar
addBar(x: number): void {
    const bar = new BoxGeometry(0, 50, 0);
    const material = new MeshPhongMaterial({ color: 0xffffff, wireframe: true });
    const tempBar = new Mesh(bar, material);
// ...
```

### 2. èµ·å§‹é¡µå›¾å½¢åŠ¨æ•ˆ

ç”±äºå¦‚æœå®Œå…¨æ­£ç»éšæœºçš„è¯, å¾ˆå¤šæƒ…å†µä¸‹, ä¼šæœ‰ä¸€äº›å›¾å½¢å¾ˆå¹¸è¿åœ°è¶Šå˜è¶Šé•¿ç›´åˆ°å……æ»¡å±å¹•. æ‰€ä»¥å˜å¤§å˜å°çš„æœºç‡å¹¶éæ˜¯ 50%, è€Œæ˜¯å˜å°çš„å‡ ç‡ä¼šç•¥å¤§äºå˜å¤§, è¿™æ ·å›¾å½¢å°±ä¼šå’ŒéŸ³æ³¢ä¸€æ ·è¶Šæ¥è¶Šå°, ç›´åˆ°æ¶ˆæ•£.

```js
// updating the bars size
update(): void {
    this.bars.forEach((bar) => {
        if (Math.random() > 0.7) {
            // random number between 0 and 1
            // it is 0.501 because we need the bars lower in general after a lot of trials
            Math.random() > 0.501 ? this.up(bar) : this.down(bar);
        }
    });
}
```

è¿˜æœ‰å°±æ˜¯åˆ‡é¡µé¢çš„æ—¶å€™è¦ call ä¸€ä¸‹ onPointerMove, è¿™æ ·é¿å…åˆ‡çš„æ¸²æŸ“æ—¶å€™çªç„¶ä¼šä» (0, 0) è·³åˆ°æŒ‡é’ˆä½ç½®. ä»¥åŠæ‰‹æœºä¸Šæ²¡æœ‰ onmouseleave, æ‰€ä»¥åœ¨ onclick çš„æ—¶å€™ä¹Ÿéœ€è¦æŠŠé¡µé¢çš„åè‰²æ¢å¤.

```js
playDOM.onclick = function (event: any) {
    // ...
    model.activeView = (model.activeView + 1) % views.length;
    // make camera not jumping
    onPointerMove(event)
};
```

### 3. Web Audio API ä½¿ç”¨

ç”±äºæµè§ˆå™¨é™åˆ¶, æˆ‘ä»¬æ— æ³•ç›´æ¥æ’­æ”¾éŸ³é¢‘, æ‰€ä»¥éœ€è¦æŒ‰é’®æ¥è§¦å‘éŸ³é¢‘çš„å‘å£°. åŒæ—¶å› ä¸ºæˆ‘ä»¬çš„é¡¹ç›®åˆ†äº†ç»„ä»¶, æ‰€ä»¥æˆ‘ä»¬æŒ‚äº†ä¸¤ä¸ªç‚¹å‡»äº‹ä»¶ç»™ä¸¤ä¸ªç»„ä»¶.

ä¸»ç»„ä»¶ (æ’­æ”¾éŸ³ä¹)

```js
// ...
// initiate the audio on clicking, hide the play button, change active view
playDOM.onclick = function () {
    audioDOM.src = model.audioSrc[Math.floor(Math.random() * model.audioSrc.length)];
};
// ...
```

å­ç»„ä»¶ (åˆ›å»º context)

```js
// ...
	if (htmlDOM) {
		// we need an event to get the audio context
		htmlDOM.onclick = function () {
			// web audio api stuffs
			const context = new AudioContext();
// ...
```

### 4. æŒ‰é’®æ ·å¼

ç”±äºæŒ‰é’®çš„ position æ˜¯ fixed, åŒæ—¶éœ€è¦æ°´å¹³å±…ä¸­, åŒæ—¶éœ€è¦æœ‰ active çš„å¤§å°å˜æ¢åŠ¨ç”», åŒæ—¶è¦æœ‰ç§»åŠ¨ç«¯é€‚é…. æ‰€ä»¥, å¦‚æœè¦è€ƒè™‘è¿™äº›æ‰€æœ‰çš„å› ç´ çš„è¯, æœ€å¥½çš„æ–¹æ³•å°±æ˜¯æŠŠå®½åº¦ä¹Ÿè®¾ç½®ä¸º vh å•ä½... ä½ å¯ä»¥ä»”ç»†æƒ³æƒ³, è¿˜æœ‰æ²¡æœ‰åŠæ³•èƒ½åŒæ—¶æ»¡è¶³è¿™äº›.

```css
/* ... */
#play {
    width: 30vh;
    height: 10vh;
    transition: all cubic-bezier(0.165, 0.84, 0.44, 1) 0.5s;
    position: fixed;
/* ... */
}
/* ... */
#play:active {
    transform: scale(0.95);
}
```

hover ä¸Šå»çš„ç‰¹æ•ˆå…¶å®ä¹Ÿå¾ˆæœ‰è¶£. hover ä¸Šå»ä¼šæœ‰ä¸€ä¸ªå…¨ç•Œé¢åè‰², ç‚¹å‡»è¿›å»ä¹‹åä¹Ÿä¼šæœ‰ä¸€ä¸ªå°å°çš„å»¶è¿Ÿ, å°±ä¼šçœ‹åˆ°çƒçš„é‚£ä¸ªé¡µé¢ä¹Ÿæ˜¯ç¨å¾®æœ‰ç‚¹é»‘çš„, ç„¶åè¿…é€Ÿå˜ç™½. è¿™ä¸ªæ˜¯æ— å¿ƒæ’æŸ³æŸ³æˆè«çš„ä¸€ä¸ªæ•ˆæœ.

![](/img/gonsa/5.png)

### 5. console çš„ log

console é‡Œé¢ä¼š log, ä¸å¯¹, info å‡ºä¸€äº›å°ä¿¡æ¯å‘€.

```js
<script>
    console.info('ğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµ')
    console.info('made by Suning Yao')
    console.info('ğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµğŸµ')
    console.info('learn more about me at suningyao.com')
</script>
```

### 6. éŸ³ä¹æ–‡ä»¶

ä¸€å¼€å§‹æ˜¯æƒ³éƒ½ç”¨ `.flac` æ ¼å¼çš„, å› ä¸ºè¿™æ ·éŸ³è´¨æœ€é«˜. ä½†æ˜¯å…¶å® `.mp3` æ ¼å¼æ²¡å•¥æ˜¾è‘—åŒºåˆ«, å¤§å°è¿˜å°ä¸€ç‚¹.

## å‚è€ƒèµ„æ–™

1. [æˆ‘çš„éŸ³ä¹äººè´¦å·](https://music.163.com/#/artist?id=12452032)
2. é¡¹ç›®çš„ä¸»è¦é€»è¾‘éƒ¨åˆ†å‚è€ƒ[è¿™ä¸ªåšå®¢](https://medium.com/@mag_ops/music-visualiser-with-three-js-web-audio-api-b30175e7b5ba)
3. [æ›´å¥½çœ‹çš„ä¸€ä¸ªéŸ³ä¹å¯è§†åŒ–é¡¹ç›®](https://jojo.ninja/fluctus/)
